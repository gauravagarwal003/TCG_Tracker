name: Update on Transaction Change

on:
  push:
    paths:
      - 'transactions.csv'
      - 'mappings.json'
    branches:
      - main
  workflow_dispatch: # Allows manual trigger

# Required for committing + pushing back to the repo
permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        persist-credentials: true
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Cache pip packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        sudo apt-get install -y p7zip-full
    
    - name: Detect changed transactions (precise)
      run: |
        python << 'EOF'
        import json
        import pandas as pd
        from datetime import datetime
        import os
        import subprocess
        import io
        from collections import Counter

        print("=== Smart Transaction Change Update ===")

        # Load config
        with open('data.json', 'r') as f:
            config = json.load(f)

        # Load transactions to find earliest Date Recieved
        df = pd.read_csv('transactions.csv')
        dates = []
        if 'Date Recieved' in df.columns:
            for d in df['Date Recieved'].dropna():
                try:
                    parsed = datetime.strptime(str(d), '%m/%d/%Y')
                    dates.append(parsed.date())
                except Exception:
                    pass

        if dates:
            earliest = min(dates)
            config['start_date'] = earliest.strftime('%Y-%m-%d')
            with open('data.json', 'w') as f:
                json.dump(config, f, indent=4)
            print(f"Earliest transaction date (Date Recieved): {earliest}")

        def normalize_id(value):
          try:
            return str(int(float(value)))
          except (ValueError, TypeError):
            return str(value).strip()

        def normalize_date(value):
          raw = str(value).strip()
          if not raw:
            return None
          for fmt in ("%m/%d/%Y", "%Y-%m-%d"):
            try:
              return datetime.strptime(raw, fmt).date()
            except Exception:
              continue
          return None

        def normalize_price(value):
          raw = str(value).strip().replace("$", "").replace(",", "")
          if raw == "" or raw.lower() == "nan":
            return None
          try:
            return round(float(raw), 4)
          except Exception:
            return None

        def normalize_qty(value):
          raw = str(value).strip()
          if raw == "" or raw.lower() == "nan":
            return None
          try:
            return round(float(raw), 4)
          except Exception:
            return None

        def build_impact_key(row, columns):
          col_map = {c: i for i, c in enumerate(columns)}
          if 'Date Recieved' not in col_map:
            return None
          date_val = normalize_date(row[col_map['Date Recieved']])
          if date_val is None:
            return None
          t_type = str(row[col_map.get('Transaction Type')]).strip().upper() if 'Transaction Type' in col_map else ''
          gid = normalize_id(row[col_map.get('group_id')]) if 'group_id' in col_map else ''
          pid = normalize_id(row[col_map.get('product_id')]) if 'product_id' in col_map else ''
          qty = normalize_qty(row[col_map.get('Quantity')]) if 'Quantity' in col_map else None
          price = normalize_price(row[col_map.get('Price Per Unit')]) if 'Price Per Unit' in col_map else None
          return (date_val, t_type, gid, pid, qty, price)

        # Read previous transactions.csv from git
        try:
          prev_csv = subprocess.check_output(
            ["git", "show", "HEAD^:transactions.csv"],
            text=True
          )
          prev_df = pd.read_csv(io.StringIO(prev_csv))
        except Exception:
          prev_df = pd.DataFrame(columns=df.columns)

        cur_cols = list(df.columns)
        prev_cols = list(prev_df.columns)

        cur_keys = [build_impact_key(row, cur_cols) for row in df.fillna('').astype(str).values.tolist()]
        prev_keys = [build_impact_key(row, prev_cols) for row in prev_df.fillna('').astype(str).values.tolist()]

        cur_keys = [k for k in cur_keys if k is not None]
        prev_keys = [k for k in prev_keys if k is not None]

        added_keys = list((Counter(cur_keys) - Counter(prev_keys)).elements())
        removed_keys = list((Counter(prev_keys) - Counter(cur_keys)).elements())

        changed_keys = added_keys if added_keys else removed_keys
        if added_keys and removed_keys:
          changed_keys = added_keys + removed_keys

        changed_dates = [k[0] for k in changed_keys if k and k[0] is not None]
        changed_products = set()
        for k in changed_keys:
          if not k:
            continue
          gid = str(k[2]).strip()
          pid = str(k[3]).strip()
          if gid and pid and gid.lower() != 'nan' and pid.lower() != 'nan':
            changed_products.add((gid, pid))

        if changed_dates:
            earliest_changed = min(changed_dates)
            print(f"Earliest changed transaction date: {earliest_changed}")
            with open(os.environ["GITHUB_ENV"], "a") as env:
                env.write(f"RESUME_DATE={earliest_changed.strftime('%Y-%m-%d')}\n")
        else:
            print("No changed transaction dates detected.")

        if changed_products:
            with open(os.environ["GITHUB_ENV"], "a") as env:
                env.write(f"CHANGED_PRODUCTS={json.dumps(sorted(changed_products))}\n")
            print(f"Changed products: {len(changed_products)}")
        else:
            print("No changed products detected.")
        EOF

    - name: Update prices and tracker (only changed products)
      run: |
        python << 'EOF'
        import os
        import json
        import update_prices
        import analyze_portfolio

        resume_date = os.environ.get("RESUME_DATE")
        products = json.loads(os.environ.get("CHANGED_PRODUCTS", "[]"))

        if products:
            print(f"Updating prices for {len(products)} changed products...")
            update_prices.main(start_from_date=resume_date, product_filter=products)
        elif resume_date:
            print("No changed products detected; running incremental price update from resume date.")
            update_prices.main(start_from_date=resume_date)
        else:
            print("No resume date set; running incremental update.")
            update_prices.main()

        analyze_portfolio.run_analysis(resume_date=resume_date)
        EOF
      continue-on-error: true
    
    - name: Build site
      run: python build_site.py
    
    - name: Commit and push if changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add -A
        if ! git diff --quiet || ! git diff --staged --quiet; then
          git commit -m "Auto-update after transaction change"
          git pull --rebase origin main
          git push
        fi
