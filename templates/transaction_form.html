{% extends 'base.html' %}

{% block content %}
<div class="table-section">
    <div class="table-header mb-3">
        <h5 class="mb-0">{{ 'Edit Transaction' if is_edit else 'Add Transaction' }}</h5>
    </div>

    <div class="table-content">
        <form method="POST" id="txnForm">
            <!-- ── Transaction Type ── -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <label for="transaction_type" class="form-label fw-semibold">Transaction Type *</label>
                    <select class="form-select" id="transaction_type" name="transaction_type" required>
                        <option value="">Select Type</option>
                        <option value="BUY"   {{ 'selected' if transaction and transaction.type == 'BUY' }}>BUY</option>
                        <option value="SELL"  {{ 'selected' if transaction and transaction.type == 'SELL' }}>SELL</option>
                        <option value="OPEN"  {{ 'selected' if transaction and transaction.type == 'OPEN' }}>OPEN</option>
                        <option value="TRADE" {{ 'selected' if transaction and transaction.type == 'TRADE' }}>TRADE</option>
                    </select>
                </div>
            </div>

            <hr class="my-4">

            <!-- ══════════════════════════════════════════════
                 NON-TRADE FIELDS  (BUY / SELL / OPEN)
                 ══════════════════════════════════════════════ -->
            <div id="standardFields" style="display: {{ 'block' if (not transaction) or (transaction and transaction.type != 'TRADE') else 'none' }};">
                <h6 class="text-primary mb-3">Product</h6>

                {% set tx_items = transaction.get('items', []) if transaction else [] %}
                {% set first_item = tx_items[0] if tx_items|length > 0 else none %}

                <!-- Product Search -->
                <div class="row mb-3">
                    <div class="col-md-12 position-relative">
                        <label for="product_search" class="form-label">Search for Product</label>
                        <input type="text"
                               class="form-control"
                               id="product_search"
                               placeholder="Start typing product name..."
                               autocomplete="off"
                               value="{{ first_item.name if first_item else '' }}">
                        <div id="search_results" class="list-group mt-1" style="display:none; position:absolute; z-index:1050; max-height:300px; overflow-y:auto; width:calc(100% - 24px);"></div>
                    </div>
                </div>

                <!-- Hidden IDs -->
                <input type="hidden" id="sel_product_id"  name="product_id"  value="{{ first_item.product_id  if first_item else '' }}">
                <input type="hidden" id="sel_group_id"    name="group_id"    value="{{ first_item.group_id    if first_item else '' }}">
                <input type="hidden" id="sel_category_id" name="category_id" value="{{ first_item.categoryId  if first_item else 3 }}">
                <input type="hidden" id="sel_name"        name="product_name" value="{{ first_item.name       if first_item else '' }}">

                <!-- New Product mini-form -->
                <div id="new_product_fields" class="mb-3" style="display:none;">
                    <div class="alert alert-info py-2">
                        <i class="fas fa-info-circle"></i> Product not found. Enter IDs manually:
                    </div>
                    <div class="row g-2 mb-2">
                        <div class="col-md-4">
                            <input type="text" class="form-control form-control-sm" id="new_product_id" placeholder="Product ID">
                        </div>
                        <div class="col-md-4">
                            <input type="text" class="form-control form-control-sm" id="new_group_id" placeholder="Group ID">
                        </div>
                        <div class="col-md-2">
                            <input type="text" class="form-control form-control-sm" id="new_category_id" placeholder="Cat ID" value="3">
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-sm btn-primary w-100" id="confirmNewProduct">Confirm</button>
                        </div>
                    </div>
                </div>

                <!-- Quantity & Amount -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="quantity" class="form-label">Quantity *</label>
                        <input type="number" class="form-control" id="quantity" name="quantity" min="1" step="1" required
                               value="{{ first_item.quantity|int if first_item else 1 }}">
                    </div>
                    <div class="col-md-4" id="amountGroup">
                        <label for="amount" class="form-label">Total Amount ($)</label>
                        <input type="number" class="form-control" id="amount" name="amount" step="0.01" min="0"
                               value="{{ '%.2f'|format(transaction.amount) if transaction and transaction.amount else '' }}">
                    </div>
                </div>
            </div>

            <!-- ══════════════════════════════════════════════
                 TRADE FIELDS
                 ══════════════════════════════════════════════ -->
            <div id="tradeFields" style="display: {{ 'block' if transaction and transaction.type == 'TRADE' else 'none' }};">
                <!-- Items Out -->
                <h6 class="text-danger mb-3"><i class="fas fa-arrow-right"></i> Items Traded Away</h6>
                <div id="itemsOutContainer">
                    {% if transaction and transaction.type == 'TRADE' %}
                        {% for item in transaction.get('items_out', []) %}
                        <div class="trade-item-row row g-2 mb-2 align-items-end">
                            <div class="col-md-5">
                                <input type="text" class="form-control form-control-sm trade-search" placeholder="Search product..." value="{{ item.name }}" data-direction="out">
                                <div class="trade-search-results list-group mt-1" style="display:none; position:absolute; z-index:1050; max-height:200px; overflow-y:auto;"></div>
                            </div>
                            <div class="col-md-2">
                                <input type="number" class="form-control form-control-sm trade-qty" placeholder="Qty" min="1" step="1" value="{{ item.quantity|int }}">
                            </div>
                            <div class="col-md-3">
                                <input type="hidden" class="trade-product-id" value="{{ item.product_id }}">
                                <input type="hidden" class="trade-group-id" value="{{ item.group_id }}">
                                <input type="hidden" class="trade-category-id" value="{{ item.categoryId }}">
                                <input type="hidden" class="trade-name" value="{{ item.name }}">
                                <small class="text-muted">{{ item.product_id }}</small>
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-sm btn-outline-danger remove-trade-item w-100">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
                <button type="button" class="btn btn-sm btn-outline-secondary mb-4" id="addItemOut">
                    <i class="fas fa-plus"></i> Add Item Out
                </button>

                <!-- Items In -->
                <h6 class="text-success mb-3"><i class="fas fa-arrow-left"></i> Items Received</h6>
                <div id="itemsInContainer">
                    {% if transaction and transaction.type == 'TRADE' %}
                        {% for item in transaction.get('items_in', []) %}
                        <div class="trade-item-row row g-2 mb-2 align-items-end">
                            <div class="col-md-5">
                                <input type="text" class="form-control form-control-sm trade-search" placeholder="Search product..." value="{{ item.name }}" data-direction="in">
                                <div class="trade-search-results list-group mt-1" style="display:none; position:absolute; z-index:1050; max-height:200px; overflow-y:auto;"></div>
                            </div>
                            <div class="col-md-2">
                                <input type="number" class="form-control form-control-sm trade-qty" placeholder="Qty" min="1" step="1" value="{{ item.quantity|int }}">
                            </div>
                            <div class="col-md-3">
                                <input type="hidden" class="trade-product-id" value="{{ item.product_id }}">
                                <input type="hidden" class="trade-group-id" value="{{ item.group_id }}">
                                <input type="hidden" class="trade-category-id" value="{{ item.categoryId }}">
                                <input type="hidden" class="trade-name" value="{{ item.name }}">
                                <small class="text-muted">{{ item.product_id }}</small>
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-sm btn-outline-danger remove-trade-item w-100">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
                <button type="button" class="btn btn-sm btn-outline-secondary mb-3" id="addItemIn">
                    <i class="fas fa-plus"></i> Add Item In
                </button>

                <!-- hidden JSON fields submitted with the form -->
                <input type="hidden" id="items_out_json" name="items_out" value="">
                <input type="hidden" id="items_in_json"  name="items_in"  value="">
            </div>

            <!-- ══════════════════════════════════════════════
                 COMMON FIELDS (all types)
                 ══════════════════════════════════════════════ -->
            <hr class="my-4">
            <h6 class="text-primary mb-3">Dates & Details</h6>

            <div class="row mb-3">
                <div class="col-md-4">
                    <label for="date_received" class="form-label">Date Received *</label>
                    <input type="date" class="form-control" id="date_received" name="date_received" required
                           value="{{ transaction.date_received if transaction else '' }}">
                </div>
                <div class="col-md-4">
                    <label for="date_purchased" class="form-label">Date Purchased</label>
                    <input type="date" class="form-control" id="date_purchased" name="date_purchased"
                           value="{{ transaction.date_purchased if transaction else '' }}">
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-4">
                    <label for="place" class="form-label">Store / Place</label>
                    <input type="text" class="form-control" id="place" name="place" placeholder="e.g., Target"
                           value="{{ transaction.place if transaction and transaction.place else '' }}">
                </div>
                <div class="col-md-4">
                    <label for="method" class="form-label">Method</label>
                    <select class="form-select" id="method" name="method">
                        <option value="">—</option>
                        <option value="Online"    {{ 'selected' if transaction and transaction.method == 'Online' }}>Online</option>
                        <option value="In-person" {{ 'selected' if transaction and transaction.method == 'In-person' }}>In-person</option>
                    </select>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-8">
                    <label for="notes" class="form-label">Notes</label>
                    <textarea class="form-control" id="notes" name="notes" rows="2" placeholder="Optional details...">{{ transaction.notes if transaction and transaction.notes else '' }}</textarea>
                </div>
            </div>

            <!-- Submit -->
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-save me-1"></i>{{ 'Update' if is_edit else 'Add' }} Transaction
                </button>
                <a href="{{ url_for('transactions_page') }}" class="btn btn-outline-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {

    /* ── references ── */
    const typeSelect   = document.getElementById('transaction_type');
    const stdFields    = document.getElementById('standardFields');
    const tradeFields  = document.getElementById('tradeFields');
    const amountGroup  = document.getElementById('amountGroup');
    const searchInput  = document.getElementById('product_search');
    const searchResults= document.getElementById('search_results');
    const newProdDiv   = document.getElementById('new_product_fields');

    /* ── Type toggle ── */
    typeSelect.addEventListener('change', toggleType);
    function toggleType() {
        const t = typeSelect.value;
        if (t === 'TRADE') {
            stdFields.style.display  = 'none';
            tradeFields.style.display = 'block';
        } else {
            stdFields.style.display  = 'block';
            tradeFields.style.display = 'none';
        }
        // Hide amount for OPEN
        if (t === 'OPEN') {
            amountGroup.style.display = 'none';
        } else {
            amountGroup.style.display = '';
        }
    }
    toggleType(); // init

    /* ── Product Search (standard) ── */
    let searchTimeout;
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const q = this.value.trim();
        if (q.length < 2) { searchResults.style.display = 'none'; return; }
        searchTimeout = setTimeout(() => {
            fetch(`/api/search_products?q=${encodeURIComponent(q)}`)
                .then(r => r.json())
                .then(products => {
                    if (products.length === 0) {
                        searchResults.innerHTML = `
                            <div class="list-group-item text-muted"><em>No products found.</em></div>
                            <div class="list-group-item list-group-item-action" id="showNewProduct" style="cursor:pointer">
                                <i class="fas fa-plus-circle text-success"></i> Add as new product
                            </div>`;
                        searchResults.style.display = 'block';
                        document.getElementById('showNewProduct').addEventListener('click', () => {
                            document.getElementById('sel_name').value = searchInput.value;
                            searchResults.style.display = 'none';
                            newProdDiv.style.display = 'block';
                        });
                    } else {
                        searchResults.innerHTML = products.map(p => `
                            <div class="list-group-item list-group-item-action" style="cursor:pointer" data-p='${JSON.stringify(p)}'>
                                <strong>${p.name}</strong><br>
                                <small class="text-muted">PID: ${p.product_id} | GID: ${p.group_id}</small>
                            </div>`).join('');
                        searchResults.style.display = 'block';
                        searchResults.querySelectorAll('.list-group-item-action').forEach(el => {
                            el.addEventListener('click', () => selectProduct(JSON.parse(el.dataset.p)));
                        });
                    }
                });
        }, 300);
    });

    document.addEventListener('click', e => {
        if (!searchInput.contains(e.target) && !searchResults.contains(e.target))
            searchResults.style.display = 'none';
    });

    function selectProduct(p) {
        searchInput.value = p.name;
        document.getElementById('sel_product_id').value  = p.product_id;
        document.getElementById('sel_group_id').value    = p.group_id;
        document.getElementById('sel_category_id').value = p.categoryId || 3;
        document.getElementById('sel_name').value        = p.name;
        searchResults.style.display = 'none';
        newProdDiv.style.display = 'none';
    }

    /* ── Confirm New Product ── */
    document.getElementById('confirmNewProduct').addEventListener('click', function() {
        const pid = document.getElementById('new_product_id').value.trim();
        const gid = document.getElementById('new_group_id').value.trim();
        const cid = document.getElementById('new_category_id').value.trim() || '3';
        if (!pid || !gid) { alert('Product ID and Group ID are required'); return; }
        document.getElementById('sel_product_id').value  = pid;
        document.getElementById('sel_group_id').value    = gid;
        document.getElementById('sel_category_id').value = cid;
        document.getElementById('sel_name').value        = searchInput.value;
        newProdDiv.style.display = 'none';
    });

    /* ── Trade item row helpers ── */
    function tradeItemRowHTML(direction) {
        return `
        <div class="trade-item-row row g-2 mb-2 align-items-end">
            <div class="col-md-5 position-relative">
                <input type="text" class="form-control form-control-sm trade-search" placeholder="Search product..." data-direction="${direction}">
                <div class="trade-search-results list-group mt-1" style="display:none; position:absolute; z-index:1050; max-height:200px; overflow-y:auto; width:100%;"></div>
            </div>
            <div class="col-md-2">
                <input type="number" class="form-control form-control-sm trade-qty" placeholder="Qty" min="1" step="1" value="1">
            </div>
            <div class="col-md-3">
                <input type="hidden" class="trade-product-id" value="">
                <input type="hidden" class="trade-group-id" value="">
                <input type="hidden" class="trade-category-id" value="3">
                <input type="hidden" class="trade-name" value="">
                <small class="text-muted trade-id-label"></small>
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-sm btn-outline-danger remove-trade-item w-100">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>`;
    }

    document.getElementById('addItemOut').addEventListener('click', () => {
        document.getElementById('itemsOutContainer').insertAdjacentHTML('beforeend', tradeItemRowHTML('out'));
    });
    document.getElementById('addItemIn').addEventListener('click', () => {
        document.getElementById('itemsInContainer').insertAdjacentHTML('beforeend', tradeItemRowHTML('in'));
    });

    /* Remove row */
    document.addEventListener('click', e => {
        if (e.target.closest('.remove-trade-item')) {
            e.target.closest('.trade-item-row').remove();
        }
    });

    /* Trade product search */
    let tradeSearchTimeout;
    document.addEventListener('input', e => {
        if (!e.target.classList.contains('trade-search')) return;
        clearTimeout(tradeSearchTimeout);
        const input = e.target;
        const resultsDiv = input.closest('.col-md-5').querySelector('.trade-search-results');
        const q = input.value.trim();
        if (q.length < 2) { resultsDiv.style.display = 'none'; return; }
        tradeSearchTimeout = setTimeout(() => {
            fetch(`/api/search_products?q=${encodeURIComponent(q)}`)
                .then(r => r.json())
                .then(products => {
                    if (products.length === 0) {
                        resultsDiv.innerHTML = '<div class="list-group-item text-muted small"><em>Not found</em></div>';
                    } else {
                        resultsDiv.innerHTML = products.map(p => `
                            <div class="list-group-item list-group-item-action py-1" style="cursor:pointer" data-p='${JSON.stringify(p)}'>
                                <strong>${p.name}</strong> <small class="text-muted">(${p.product_id})</small>
                            </div>`).join('');
                        resultsDiv.querySelectorAll('.list-group-item-action').forEach(el => {
                            el.addEventListener('click', () => {
                                const p = JSON.parse(el.dataset.p);
                                const row = input.closest('.trade-item-row');
                                input.value = p.name;
                                row.querySelector('.trade-product-id').value  = p.product_id;
                                row.querySelector('.trade-group-id').value    = p.group_id;
                                row.querySelector('.trade-category-id').value = p.categoryId || 3;
                                row.querySelector('.trade-name').value        = p.name;
                                row.querySelector('.trade-id-label').textContent = p.product_id;
                                resultsDiv.style.display = 'none';
                            });
                        });
                    }
                    resultsDiv.style.display = 'block';
                });
        }, 300);
    });

    /* Close trade results on click outside */
    document.addEventListener('click', e => {
        document.querySelectorAll('.trade-search-results').forEach(d => {
            if (!d.contains(e.target) && !d.previousElementSibling?.contains(e.target))
                d.style.display = 'none';
        });
    });

    /* ── Form Submission ── */
    document.getElementById('txnForm').addEventListener('submit', function(e) {
        const type = typeSelect.value;
        if (!type) { e.preventDefault(); alert('Select a transaction type'); return; }

        if (type === 'TRADE') {
            // Build items_out / items_in JSON
            const itemsOut = collectTradeItems('itemsOutContainer');
            const itemsIn  = collectTradeItems('itemsInContainer');
            if (itemsOut.length === 0 || itemsIn.length === 0) {
                e.preventDefault();
                alert('TRADE requires at least one item out and one item in.');
                return;
            }
            document.getElementById('items_out_json').value = JSON.stringify(itemsOut);
            document.getElementById('items_in_json').value  = JSON.stringify(itemsIn);
        } else {
            // Build single items JSON for hidden field
            const pid  = document.getElementById('sel_product_id').value;
            const gid  = document.getElementById('sel_group_id').value;
            const cid  = document.getElementById('sel_category_id').value;
            const name = document.getElementById('sel_name').value;
            const qty  = parseInt(document.getElementById('quantity').value) || 1;
            if (!pid || !gid || !name) {
                e.preventDefault();
                alert('Please search and select a product first.');
                return;
            }
            // inject hidden items field
            let itemsField = document.getElementById('items_json_hidden');
            if (!itemsField) {
                itemsField = document.createElement('input');
                itemsField.type = 'hidden';
                itemsField.id   = 'items_json_hidden';
                itemsField.name = 'items';
                this.appendChild(itemsField);
            }
            itemsField.value = JSON.stringify([{
                product_id: parseInt(pid),
                group_id: parseInt(gid),
                categoryId: parseInt(cid),
                name: name,
                quantity: qty
            }]);
        }
    });

    function collectTradeItems(containerId) {
        const items = [];
        document.getElementById(containerId).querySelectorAll('.trade-item-row').forEach(row => {
            const pid  = row.querySelector('.trade-product-id').value;
            const gid  = row.querySelector('.trade-group-id').value;
            const cid  = row.querySelector('.trade-category-id').value;
            const name = row.querySelector('.trade-name').value;
            const qty  = parseInt(row.querySelector('.trade-qty').value) || 1;
            if (pid && gid && name) {
                items.push({
                    product_id: parseInt(pid),
                    group_id: parseInt(gid),
                    categoryId: parseInt(cid),
                    name: name,
                    quantity: qty
                });
            }
        });
        return items;
    }
});
</script>

<style>
.trade-search-results .list-group-item-action:hover { background-color: #f8f9fa; }
#search_results .list-group-item-action:hover { background-color: #f8f9fa; }
</style>
{% endblock %}
