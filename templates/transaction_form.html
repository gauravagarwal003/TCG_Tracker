{% extends 'base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">{{ title }}</h4>
            </div>
            <div class="card-body">
                <form method="post" id="transactionForm">

                    <!-- Product Selection -->
                    <div class="mb-4">
                        <label for="product_search" class="form-label">Product</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="product_search" placeholder="Type to search..." autocomplete="off">
                            <button class="btn btn-outline-secondary" type="button" id="btn_toggle_new">
                                <i class="fas fa-plus"></i> New Product
                            </button>
                        </div>
                        <div id="autocomplete-list" class="autocomplete-items"></div>
                        
                        <!-- Hidden fields that hold the actual data -->
                        <input type="hidden" id="item_name" name="item" value="{{ transaction.get('Item', '') }}">
                        <input type="hidden" id="group_id" name="group_id" value="{{ transaction.get('group_id', '') }}">
                        <input type="hidden" id="product_id" name="product_id" value="{{ transaction.get('product_id', '') }}">
                    </div>

                    <!-- New Product / Manual Entry Fields -->
                    <div id="new_product_section" class="card mb-4 bg-light border-0" style="display: none;">
                        <div class="card-body">
                            <h6 class="card-title text-primary"><i class="fas fa-magic"></i> New Product Setup</h6>
                            <p class="small text-muted">Enter the IDs below. Image and Store URLs will be automatically generated.</p>
                            
                            <div class="mb-3">
                                <label for="manual_name" class="form-label">Product Name</label>
                                <input type="text" class="form-control" id="manual_name">
                            </div>

                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label for="new_product_id" class="form-label">Product ID</label>
                                    <input type="text" class="form-control" name="new_product_id" id="new_product_id">
                                </div>
                                <div class="col-md-4">
                                    <label for="new_group_id" class="form-label">Group ID</label>
                                    <input type="text" class="form-control" name="new_group_id" id="new_group_id">
                                </div>
                                <div class="col-md-4">
                                    <label for="new_category_id" class="form-label">Category ID</label>
                                    <input type="number" class="form-control" name="new_category_id" id="new_category_id" value="3">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Dates -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="date_purchased" class="form-label">Date Purchased</label>
                            <input type="date" class="form-control" id="date_purchased" name="date_purchased"
                                   value="{{ transaction.get('Date Purchased', '') | replace('/', '-') }}" required> 
                        </div>
                        <div class="col-md-6">
                            <label for="date_received" class="form-label">Date Received</label>
                            <input type="date" class="form-control" id="date_received" name="date_received"
                                   value="{{ transaction.get('Date Recieved', '') }}">
                        </div>
                    </div>

                    <!-- Type / Price / Qty -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="transaction_type" class="form-label">Type</label>
                            <select class="form-select" id="transaction_type" name="transaction_type">
                                <option value="BUY"  {% if transaction.get('Transaction Type') == 'BUY' %}selected{% endif %}>BUY</option>
                                <option value="SELL" {% if transaction.get('Transaction Type') == 'SELL' %}selected{% endif %}>SELL</option>
                                <option value="OPEN" {% if transaction.get('Transaction Type') == 'OPEN' %}selected{% endif %}>OPEN</option>
                                <option value="PULL" {% if transaction.get('Transaction Type') == 'PULL' %}selected{% endif %}>PULL</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="price_per_unit" class="form-label">Price Per Unit ($)</label>
                            <input type="number" step="0.01" class="form-control" id="price_per_unit" name="price_per_unit"
                                   value="{{ transaction.get('Price Per Unit', '') | replace('$', '') }}">
                        </div>
                        <div class="col-md-4">
                            <label for="quantity" class="form-label">Quantity</label>
                            <input type="number" class="form-control" id="quantity" name="quantity"
                                   value="{{ transaction.get('Quantity', 1) }}" required>
                        </div>
                    </div>

                    <!-- Extra Info -->
                    <div class="row mb-3">
                         <div class="col-md-6">
                            <label for="method" class="form-label">Method</label>
                            <select class="form-select" id="method" name="method">
                                <option value="Online" {% if transaction.get('Method') == 'Online' %}selected{% endif %}>Online</option>
                                <option value="In-person" {% if transaction.get('Method') == 'In-person' %}selected{% endif %}>In-person</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="place" class="form-label">Place/Store</label>
                            <input type="text" class="form-control" id="place" name="place"
                                   value="{{ transaction.get('Place', '') }}">
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3">{{ transaction.get('Notes', '') }}</textarea>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">Save Transaction</button>
                        <a href="{{ url_for('transactions') }}" class="btn btn-outline-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    const mappings = {{ mappings | tojson }};

    const searchInput = document.getElementById('product_search');
    const autoList = document.getElementById('autocomplete-list');
    const itemNameInput = document.getElementById('item_name');
    const groupIdInput = document.getElementById('group_id');
    const productIdInput = document.getElementById('product_id');
    
    // New Product Fields
    const btnToggleNew = document.getElementById('btn_toggle_new');
    const newProductSection = document.getElementById('new_product_section');
    const manualNameInput = document.getElementById('manual_name');
    const newProductIdInput = document.getElementById('new_product_id');
    const newGroupIdInput = document.getElementById('new_group_id');
    
    let isNewProductMode = false;

    // Initialize with existing data if editing
    if (itemNameInput.value) {
        searchInput.value = itemNameInput.value;
    }
    
    // Handle Date Format fix
    function formatDateForInput(dateStr) {
        if (!dateStr || dateStr.includes('-')) return dateStr;
        const parts = dateStr.split('/');
        // Assuming M/D/YYYY
        if (parts.length === 3) {
            return `${parts[2]}-${parts[0].padStart(2,'0')}-${parts[1].padStart(2,'0')}`;
        }
        return dateStr;
    }
    
    // Set initial date values correctly
    const dpVal = "{{ transaction.get('Date Purchased', '') }}";
    const drVal = "{{ transaction.get('Date Recieved', '') }}";
    document.getElementById('date_purchased').value = formatDateForInput(dpVal);
    document.getElementById('date_received').value = formatDateForInput(drVal);


    // Filter function
    searchInput.addEventListener('input', function(e) {
        if (isNewProductMode) return; 

        const val = this.value;
        closeAllLists();
        if (!val) return;

        let matches = mappings.filter(m => m.name.toLowerCase().includes(val.toLowerCase()));
        
        matches.forEach(match => {
            const div = document.createElement("div");
            div.innerHTML = `<strong>${match.name.substr(0, val.length)}</strong>${match.name.substr(val.length)}`;
            div.innerHTML += `<br><small class='text-muted'>ID: ${match.product_id}</small>`;
            div.addEventListener("click", function() {
                selectProduct(match);
            });
            autoList.appendChild(div);
        });
    });

    function selectProduct(product) {
        searchInput.value = product.name;
        itemNameInput.value = product.name;
        groupIdInput.value = product.group_id;
        productIdInput.value = product.product_id;
        closeAllLists();
        
        toggleNewProductMode(false);
    }

    function closeAllLists(elmnt) {
        while (autoList.firstChild) {
            autoList.removeChild(autoList.firstChild);
        }
    }

    document.addEventListener("click", function (e) {
        closeAllLists(e.target);
    });

    btnToggleNew.addEventListener('click', function() {
        toggleNewProductMode(!isNewProductMode);
    });

    function toggleNewProductMode(active) {
        isNewProductMode = active;
        if (active) {
            newProductSection.style.display = 'block';
            searchInput.disabled = true;
            searchInput.placeholder = "Enter name below...";
            searchInput.value = "";
            
            btnToggleNew.classList.remove('btn-outline-secondary');
            btnToggleNew.classList.add('btn-danger');
            btnToggleNew.innerHTML = '<i class="fas fa-times"></i> Cancel';
            
            // Clear hidden IDs
            groupIdInput.value = "";
            productIdInput.value = "";
            
        } else {
            newProductSection.style.display = 'none';
            searchInput.disabled = false;
            searchInput.placeholder = "Type to search...";
            
            // Restore search input from hidden name
            if (itemNameInput.value) {
                searchInput.value = itemNameInput.value;
            }

            btnToggleNew.classList.remove('btn-danger');
            btnToggleNew.classList.add('btn-outline-secondary');
            btnToggleNew.innerHTML = '<i class="fas fa-plus"></i> New Product';
        }
    }

    // Sync manual name to hidden field
    manualNameInput.addEventListener('input', function() {
        itemNameInput.value = this.value;
    });
    
    document.getElementById('transactionForm').addEventListener('submit', function(e) {
        
        const dp = document.getElementById('date_purchased');
        const dr = document.getElementById('date_received');
        
        if(dp.value.includes('-')) {
             const [y, m, d] = dp.value.split('-');
             const hiddenDp = document.createElement('input');
             hiddenDp.type = 'hidden';
             hiddenDp.name = 'date_purchased'; 
             hiddenDp.value = `${parseInt(m)}/${parseInt(d)}/${y}`; 
             
             dp.disabled = true;
             this.appendChild(hiddenDp);
        }
        
        if(dr.value && dr.value.includes('-')) {
             const [y, m, d] = dr.value.split('-');
             const hiddenDr = document.createElement('input');
             hiddenDr.type = 'hidden';
             hiddenDr.name = 'date_received'; 
             hiddenDr.value = `${parseInt(m)}/${parseInt(d)}/${y}`;
             
             dr.disabled = true;
             this.appendChild(hiddenDr);
        }
        
        if (isNewProductMode) {
             groupIdInput.value = newGroupIdInput.value;
             productIdInput.value = newProductIdInput.value;
        }
    });

</script>
{% endblock %}
